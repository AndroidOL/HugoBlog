<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="生活中那些安静流淌、不易察觉的诗意总是令人充满好奇。迷上了延时摄影因为它能将漫长的时间压缩成迷人的瞬间，让我们得以用肉眼观察到那些缓慢发生的变化，这本身就像一种时间的魔法。\n">
<title>我的智能小助手：一个会“偷懒”的延时摄影系统</title>

<link rel='canonical' href='https://www.tianhao.me/posts/rk-camera-capture/'>

<link rel="stylesheet" href="/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css"><meta property='og:title' content="我的智能小助手：一个会“偷懒”的延时摄影系统">
<meta property='og:description' content="生活中那些安静流淌、不易察觉的诗意总是令人充满好奇。迷上了延时摄影因为它能将漫长的时间压缩成迷人的瞬间，让我们得以用肉眼观察到那些缓慢发生的变化，这本身就像一种时间的魔法。\n">
<meta property='og:url' content='https://www.tianhao.me/posts/rk-camera-capture/'>
<meta property='og:site_name' content='牙刷刷的小站'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts' /><meta property='article:published_time' content='2025-07-12T15:38:51&#43;08:00'/><meta property='article:modified_time' content='2025-07-12T15:38:51&#43;08:00'/>
<meta name="twitter:title" content="我的智能小助手：一个会“偷懒”的延时摄影系统">
<meta name="twitter:description" content="生活中那些安静流淌、不易察觉的诗意总是令人充满好奇。迷上了延时摄影因为它能将漫长的时间压缩成迷人的瞬间，让我们得以用肉眼观察到那些缓慢发生的变化，这本身就像一种时间的魔法。\n">
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column compact"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_f509edb42ecc0ebd.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">🍥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">牙刷刷的小站</a></h1>
            <h2 class="site-description">欢迎来到牙刷刷的小站</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/AndroidOL'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://www.tianhao.me/" selected>中文</option>
                                
                                    <option value="https://www.tianhao.me/en/" >English</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    

            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/posts/rk-camera-capture/">我的智能小助手：一个会“偷懒”的延时摄影系统</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">121251&#43;08-712</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 21 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>生活中那些安静流淌、不易察觉的诗意总是令人充满好奇。迷上了延时摄影因为它能将漫长的时间压缩成迷人的瞬间，让我们得以用肉眼观察到那些缓慢发生的变化，这本身就像一种时间的魔法。</p>
<p>于是，我翻出了家里那个在抽屉里沉睡了数年的 USB 摄像头，心中涌起一个温柔的念头：我想用它来记录，记录那些被我们匆忙忽略的、生活本身的呼吸。比如阳台上那盆多肉，如何在阳光的亲吻下，用我们看不见的速度悄悄舒展；窗外的云朵，又是如何被无形的手塑造成流动的雕塑；甚至是傍晚时分，夕阳如何在客厅的地板上，一寸寸地拉出长长的、温暖的影子……</p>
<p>项目代码：https://github.com/AndroidOL/camera-capture</p>
<h2 id="从勤奋的笨蛋到聪明的懒汉一次理念的进化">从“勤奋的笨蛋”到“聪明的懒汉”：一次理念的进化
</h2><p>最开始，我的想法和大多数人一样，简单而直接：写一个脚本，让摄像头化身为一个不知疲倦的“劳动模范”，每分钟准时打卡，忠实地拍下一张照片。当我敲下最后一行代码并成功运行的那一刻，心中充满了小小的成就感。然而，这份喜悦在第二天清晨，当我检视成果时，便迅速被一种混杂着困惑与失望的复杂情绪所取代。</p>
<p>硬盘里，一千四百四十张照片整齐地排列着，它们是我的程序“勤奋”一整天的见证。但我快速滚动预览时，画面却像卡住了一样，静止得令人窒息。尤其是在那漫长的深夜时段，凌晨三点和三点零一分的客厅照片，别说茶几上的灰尘纹丝未动，就连空气本身，似乎都凝固在了那一刻。我忽然意识到，我创造的不是一个记录“变化”的工具，而是一个生产“重复”的工厂。</p>
<p>当我冷静下来，把这笔“数字遗产”量化后，我才真正理解了问题的严重性：</p>
<h3 id="惊人的存储消耗">惊人的存储消耗：
</h3><ul>
<li><strong>日产量</strong>: 43200 张照片</li>
<li><strong>月产量</strong>: 约 1296000 张照片</li>
<li><strong>年产量</strong>: 超过 473040000 张照片</li>
</ul>
<p>按每张照片分辨率 1920*1080 存储，每张照片占用大小 0.2MB 计算，每天将消耗近 8GB 的存储空间，对于家庭存储而言这并不算什么。但是对于嵌入式设备，ESP32 抑或是 RK 的单板机而言有点超出限制。</p>
<h3 id="毁灭性的后期工作">毁灭性的后期工作：
</h3><ul>
<li><strong>素材筛选</strong>: 为了剪辑出几分钟的精彩视频，需要在数十万张几乎相同的“废片”中大海捞针。</li>
<li><strong>时间成本</strong>: 这哪里是艺术创作，分明是一场能耗尽所有热情的体力劳动。</li>
</ul>
<p>为了更直观地展示这两种思路的差异，我做了一个简单的对比：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>特性</th>
          <th>“勤奋的笨蛋”模式</th>
          <th>“聪明的懒汉”模式</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>工作原则</strong></td>
          <td>无差别、定时记录</td>
          <td>智能判断、按需记录</td>
      </tr>
      <tr>
          <td><strong>每时照片数量</strong></td>
          <td>恒定 1800 张</td>
          <td>几十到几百张不等，视变化而定</td>
      </tr>
      <tr>
          <td><strong>存储友好度</strong></td>
          <td>极低，呈线性爆炸增长</td>
          <td>极高，只为有效信息付费</td>
      </tr>
      <tr>
          <td><strong>后期工作量</strong></td>
          <td>巨大，筛选过程极其痛苦</td>
          <td>极小，几乎每张都是有效素材</td>
      </tr>
      <tr>
          <td><strong>最终成果质量</strong></td>
          <td>包含大量静止、无意义的“垃圾时间”</td>
          <td>节奏紧凑，聚焦于“变化”的精华</td>
      </tr>
  </tbody>
</table></div>
<p>显然，我需要的是后者。一个真正懂得“什么时候该出手，什么时候该摸鱼”的、充满智慧的——聪明的懒汉。</p>
<h2 id="给摄像头装上大脑懒惰是第一生产力">给摄像头装上“大脑”：懒惰是第一生产力
</h2><p>于是，我决定对我的摄影系统进行一次彻底的、颠覆性的“智能化”升级。这次，我没有教它如何更努力地工作，恰恰相反，我教给了它一门艺术——如何合理地“偷懒”。</p>
<p>它的核心工作原理，就像一位经验老道、洞察敏锐的情报官，他从不屑于上报那些“一切正常”的乏味报告，而只在“有情况”时才发出电报。</p>
<p>为了让它具备这种高级的判断力，我为它设计了三步走的“智慧流程”：</p>
<h3 id="视觉的纯化看见本质而非表象">视觉的纯化：看见本质，而非表象
</h3><p>清晨的冷光和傍晚的暖光，会给同一场景染上截然不同的色调，但物体本身可能纹丝未动。因此，系统在比较前，会先把彩色画面和存档照片都转换为只有黑白灰的“素描模式”（灰度化）。</p>
<h3 id="变化的度量为不同赋予权重">变化的度量：为“不同”赋予权重
</h3><p>系统将两张黑白照片进行像素级的叠加比对，生成“变化地图”，并计算其中亮色区域占比，得出变化率百分比，用于衡量“发生了什么”。</p>
<h3 id="决断的艺术设定一条智慧的偷懒基准">决断的艺术：设定一条智慧的“偷懒”基准
</h3><p>我为它设定了一个阈值，例如 0.5%。低于此值则跳过拍摄，只有当变化显著时才记录，节省资源、聚焦重要。</p>
<h2 id="生活中的贴心管家一个高度自律的系统">生活中的贴心管家：一个高度自律的系统
</h2><p>为了让它能 7x24 小时稳定运行，我设计了以下几套机制：</p>
<h3 id="量身定制的生物钟">量身定制的“生物钟”
</h3><p>根据家庭节奏设定不同频率的检测：</p>
<ul>
<li><strong>晨光捕捉 (6-8点)</strong>：每 5 秒捕捉一次</li>
<li><strong>日间活跃 (8-18点)</strong>：每 2 秒捕捉一次</li>
<li><strong>黄昏慢品 (18-22点)</strong>：每 5 秒捕捉一次</li>
<li><strong>午夜巡航 (22-6点)</strong>：每 10 秒捕捉一次</li>
</ul>
<h3 id="深谋远虑的空间魔法">深谋远虑的“空间魔法”
</h3><p>当存储使用接近 85% 时，系统自动删除最旧的存档，确保运行空间始终充足。</p>
<h3 id="百折不挠的生存本能">百折不挠的“生存本能”
</h3><p>面对断电、摄像头失联等异常，系统具备重连重试机制，最大程度自愈保持在线。</p>
<h2 id="意外的收获成为生活的静谧观察者">意外的收获：成为生活的静谧观察者
</h2><p>系统的运行成果，远超预期，它让我发现：</p>
<h3 id="微缩的家庭日晷">微缩的家庭日晷
</h3><p>追踪阳光在家中地板上的路径变化，像一个巨大的光影时钟。</p>
<h3 id="植物的无声舞蹈">植物的无声舞蹈
</h3><p>延时视频中能看见多肉转动身体朝向太阳，充满生命的对话。</p>
<h3 id="窗外的流动风景">窗外的流动风景
</h3><p>记录窗外云卷云舒、雪后屋顶融化的水滴落下，一切如诗如画。</p>
<h2 id="创造的乐趣在于过程本身">创造的乐趣，在于过程本身
</h2><p>从想法萌芽到系统成熟，这个从 0 到 1 的过程带给我的满足感是难以言喻的。</p>
<p>技术的魅力不在于它多复杂，而在于我们如何运用它去理解和体验生活。</p>
<p>如果你也对创造充满热情，那就从一个微小的点子开始吧。真正的门槛，从不在工具，而在你那份愿意“折腾”的初心。</p>
<p><strong>开启你的创造之旅吧，去记录下属于你自己的、独一无二的时光故事。</strong></p>
<p>项目代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span><span class="lnt">541
</span><span class="lnt">542
</span><span class="lnt">543
</span><span class="lnt">544
</span><span class="lnt">545
</span><span class="lnt">546
</span><span class="lnt">547
</span><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span><span class="lnt">563
</span><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span><span class="lnt">568
</span><span class="lnt">569
</span><span class="lnt">570
</span><span class="lnt">571
</span><span class="lnt">572
</span><span class="lnt">573
</span><span class="lnt">574
</span><span class="lnt">575
</span><span class="lnt">576
</span><span class="lnt">577
</span><span class="lnt">578
</span><span class="lnt">579
</span><span class="lnt">580
</span><span class="lnt">581
</span><span class="lnt">582
</span><span class="lnt">583
</span><span class="lnt">584
</span><span class="lnt">585
</span><span class="lnt">586
</span><span class="lnt">587
</span><span class="lnt">588
</span><span class="lnt">589
</span><span class="lnt">590
</span><span class="lnt">591
</span><span class="lnt">592
</span><span class="lnt">593
</span><span class="lnt">594
</span><span class="lnt">595
</span><span class="lnt">596
</span><span class="lnt">597
</span><span class="lnt">598
</span><span class="lnt">599
</span><span class="lnt">600
</span><span class="lnt">601
</span><span class="lnt">602
</span><span class="lnt">603
</span><span class="lnt">604
</span><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span><span class="lnt">624
</span><span class="lnt">625
</span><span class="lnt">626
</span><span class="lnt">627
</span><span class="lnt">628
</span><span class="lnt">629
</span><span class="lnt">630
</span><span class="lnt">631
</span><span class="lnt">632
</span><span class="lnt">633
</span><span class="lnt">634
</span><span class="lnt">635
</span><span class="lnt">636
</span><span class="lnt">637
</span><span class="lnt">638
</span><span class="lnt">639
</span><span class="lnt">640
</span><span class="lnt">641
</span><span class="lnt">642
</span><span class="lnt">643
</span><span class="lnt">644
</span><span class="lnt">645
</span><span class="lnt">646
</span><span class="lnt">647
</span><span class="lnt">648
</span><span class="lnt">649
</span><span class="lnt">650
</span><span class="lnt">651
</span><span class="lnt">652
</span><span class="lnt">653
</span><span class="lnt">654
</span><span class="lnt">655
</span><span class="lnt">656
</span><span class="lnt">657
</span><span class="lnt">658
</span><span class="lnt">659
</span><span class="lnt">660
</span><span class="lnt">661
</span><span class="lnt">662
</span><span class="lnt">663
</span><span class="lnt">664
</span><span class="lnt">665
</span><span class="lnt">666
</span><span class="lnt">667
</span><span class="lnt">668
</span><span class="lnt">669
</span><span class="lnt">670
</span><span class="lnt">671
</span><span class="lnt">672
</span><span class="lnt">673
</span><span class="lnt">674
</span><span class="lnt">675
</span><span class="lnt">676
</span><span class="lnt">677
</span><span class="lnt">678
</span><span class="lnt">679
</span><span class="lnt">680
</span><span class="lnt">681
</span><span class="lnt">682
</span><span class="lnt">683
</span><span class="lnt">684
</span><span class="lnt">685
</span><span class="lnt">686
</span><span class="lnt">687
</span><span class="lnt">688
</span><span class="lnt">689
</span><span class="lnt">690
</span><span class="lnt">691
</span><span class="lnt">692
</span><span class="lnt">693
</span><span class="lnt">694
</span><span class="lnt">695
</span><span class="lnt">696
</span><span class="lnt">697
</span><span class="lnt">698
</span><span class="lnt">699
</span><span class="lnt">700
</span><span class="lnt">701
</span><span class="lnt">702
</span><span class="lnt">703
</span><span class="lnt">704
</span><span class="lnt">705
</span><span class="lnt">706
</span><span class="lnt">707
</span><span class="lnt">708
</span><span class="lnt">709
</span><span class="lnt">710
</span><span class="lnt">711
</span><span class="lnt">712
</span><span class="lnt">713
</span><span class="lnt">714
</span><span class="lnt">715
</span><span class="lnt">716
</span><span class="lnt">717
</span><span class="lnt">718
</span><span class="lnt">719
</span><span class="lnt">720
</span><span class="lnt">721
</span><span class="lnt">722
</span><span class="lnt">723
</span><span class="lnt">724
</span><span class="lnt">725
</span><span class="lnt">726
</span><span class="lnt">727
</span><span class="lnt">728
</span><span class="lnt">729
</span><span class="lnt">730
</span><span class="lnt">731
</span><span class="lnt">732
</span><span class="lnt">733
</span><span class="lnt">734
</span><span class="lnt">735
</span><span class="lnt">736
</span><span class="lnt">737
</span><span class="lnt">738
</span><span class="lnt">739
</span><span class="lnt">740
</span><span class="lnt">741
</span><span class="lnt">742
</span><span class="lnt">743
</span><span class="lnt">744
</span><span class="lnt">745
</span><span class="lnt">746
</span><span class="lnt">747
</span><span class="lnt">748
</span><span class="lnt">749
</span><span class="lnt">750
</span><span class="lnt">751
</span><span class="lnt">752
</span><span class="lnt">753
</span><span class="lnt">754
</span><span class="lnt">755
</span><span class="lnt">756
</span><span class="lnt">757
</span><span class="lnt">758
</span><span class="lnt">759
</span><span class="lnt">760
</span><span class="lnt">761
</span><span class="lnt">762
</span><span class="lnt">763
</span><span class="lnt">764
</span><span class="lnt">765
</span><span class="lnt">766
</span><span class="lnt">767
</span><span class="lnt">768
</span><span class="lnt">769
</span><span class="lnt">770
</span><span class="lnt">771
</span><span class="lnt">772
</span><span class="lnt">773
</span><span class="lnt">774
</span><span class="lnt">775
</span><span class="lnt">776
</span><span class="lnt">777
</span><span class="lnt">778
</span><span class="lnt">779
</span><span class="lnt">780
</span><span class="lnt">781
</span><span class="lnt">782
</span><span class="lnt">783
</span><span class="lnt">784
</span><span class="lnt">785
</span><span class="lnt">786
</span><span class="lnt">787
</span><span class="lnt">788
</span><span class="lnt">789
</span><span class="lnt">790
</span><span class="lnt">791
</span><span class="lnt">792
</span><span class="lnt">793
</span><span class="lnt">794
</span><span class="lnt">795
</span><span class="lnt">796
</span><span class="lnt">797
</span><span class="lnt">798
</span><span class="lnt">799
</span><span class="lnt">800
</span><span class="lnt">801
</span><span class="lnt">802
</span><span class="lnt">803
</span><span class="lnt">804
</span><span class="lnt">805
</span><span class="lnt">806
</span><span class="lnt">807
</span><span class="lnt">808
</span><span class="lnt">809
</span><span class="lnt">810
</span><span class="lnt">811
</span><span class="lnt">812
</span><span class="lnt">813
</span><span class="lnt">814
</span><span class="lnt">815
</span><span class="lnt">816
</span><span class="lnt">817
</span><span class="lnt">818
</span><span class="lnt">819
</span><span class="lnt">820
</span><span class="lnt">821
</span><span class="lnt">822
</span><span class="lnt">823
</span><span class="lnt">824
</span><span class="lnt">825
</span><span class="lnt">826
</span><span class="lnt">827
</span><span class="lnt">828
</span><span class="lnt">829
</span><span class="lnt">830
</span><span class="lnt">831
</span><span class="lnt">832
</span><span class="lnt">833
</span><span class="lnt">834
</span><span class="lnt">835
</span><span class="lnt">836
</span><span class="lnt">837
</span><span class="lnt">838
</span><span class="lnt">839
</span><span class="lnt">840
</span><span class="lnt">841
</span><span class="lnt">842
</span><span class="lnt">843
</span><span class="lnt">844
</span><span class="lnt">845
</span><span class="lnt">846
</span><span class="lnt">847
</span><span class="lnt">848
</span><span class="lnt">849
</span><span class="lnt">850
</span><span class="lnt">851
</span><span class="lnt">852
</span><span class="lnt">853
</span><span class="lnt">854
</span><span class="lnt">855
</span><span class="lnt">856
</span><span class="lnt">857
</span><span class="lnt">858
</span><span class="lnt">859
</span><span class="lnt">860
</span><span class="lnt">861
</span><span class="lnt">862
</span><span class="lnt">863
</span><span class="lnt">864
</span><span class="lnt">865
</span><span class="lnt">866
</span><span class="lnt">867
</span><span class="lnt">868
</span><span class="lnt">869
</span><span class="lnt">870
</span><span class="lnt">871
</span><span class="lnt">872
</span><span class="lnt">873
</span><span class="lnt">874
</span><span class="lnt">875
</span><span class="lnt">876
</span><span class="lnt">877
</span><span class="lnt">878
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">cv2</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging.handlers</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">signal</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">shutil</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">traceback</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">time</span> <span class="k">as</span> <span class="n">dt_time</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Event</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- Script Information ---</span>
</span></span><span class="line"><span class="cl"><span class="n">SCRIPT_VERSION</span> <span class="o">=</span> <span class="s2">&#34;2.0.1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">SCRIPT_NAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- Default Configuration ---</span>
</span></span><span class="line"><span class="cl"><span class="n">BASE_APP_DIR</span> <span class="o">=</span> <span class="s2">&#34;/opt/camera/&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">LOG_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_APP_DIR</span><span class="p">,</span> <span class="s1">&#39;logs&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">PID_FILE_PATH</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;/var/run/</span><span class="si">{</span><span class="n">SCRIPT_NAME</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="s1">&#39;.pid&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">IMAGE_SAVE_BASE_DIR</span> <span class="o">=</span> <span class="s2">&#34;/opt/camera/captures&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">LOG_LEVEL_CONFIG</span> <span class="o">=</span> <span class="s2">&#34;INFO&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">LOG_FILE_NAME</span> <span class="o">=</span> <span class="s2">&#34;image_capture&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">LOG_ROTATE_WHEN</span> <span class="o">=</span> <span class="s2">&#34;midnight&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">LOG_ROTATE_INTERVAL</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">LOG_ROTATE_BACKUP_COUNT</span> <span class="o">=</span> <span class="mi">30</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">DEFAULT_CAMERA_INDEX</span> <span class="o">=</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">DEFAULT_CAMERA_DEVICE_PATH</span> <span class="o">=</span> <span class="s2">&#34;/dev/v4l/by-id/usb-Sonix_Technology_Co.__Ltd._UGREEN_Camera_2K_SN0001-video-index0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">DEFAULT_WIDTH</span> <span class="o">=</span> <span class="mi">1920</span>
</span></span><span class="line"><span class="cl"><span class="n">DEFAULT_HEIGHT</span> <span class="o">=</span> <span class="mi">1080</span>
</span></span><span class="line"><span class="cl"><span class="n">REQUESTED_FOURCC</span> <span class="o">=</span> <span class="s1">&#39;YUYV&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">JPEG_SAVE_QUALITY</span> <span class="o">=</span> <span class="mi">90</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">CAPTURE_SCHEDULE_CONFIG</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s2">&#34;end_time_exclusive&#34;</span><span class="p">:</span> <span class="n">dt_time</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&#34;interval_seconds&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s2">&#34;end_time_exclusive&#34;</span><span class="p">:</span> <span class="n">dt_time</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="s2">&#34;interval_seconds&#34;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s2">&#34;end_time_exclusive&#34;</span><span class="p">:</span> <span class="n">dt_time</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>  <span class="s2">&#34;interval_seconds&#34;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s2">&#34;end_time_exclusive&#34;</span><span class="p">:</span> <span class="n">dt_time</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>  <span class="s2">&#34;interval_seconds&#34;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">DEFAULT_INTERVAL_LATE_NIGHT</span> <span class="o">=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">PARAMETER_SET_RETRIES</span> <span class="o">=</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">PARAMETER_SET_DELAY_SECONDS</span> <span class="o">=</span> <span class="mf">0.5</span>
</span></span><span class="line"><span class="cl"><span class="n">CAMERA_INIT_FAILURE_MAX_CONSECUTIVE</span> <span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="n">CAMERA_INIT_RETRY_DELAY_SECONDS</span> <span class="o">=</span> <span class="mi">15</span>
</span></span><span class="line"><span class="cl"><span class="n">CAMERA_INIT_LONG_BACKOFF_SECONDS</span> <span class="o">=</span> <span class="mi">300</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># MODIFICATION v2.0.1: New config for read failures</span>
</span></span><span class="line"><span class="cl"><span class="n">MAX_CONSECUTIVE_READ_FAILURES</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># Max consecutive cap.read() failures before longer pause</span>
</span></span><span class="line"><span class="cl"><span class="n">READ_FAILURE_LONG_BACKOFF_SECONDS</span> <span class="o">=</span> <span class="mi">60</span> <span class="c1"># Longer pause after max read failures</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">FRAME_READ_ERROR_RETRY_DELAY_SECONDS</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># Short delay after a single read failure</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># MODIFICATION v2.0.1: New config for imwrite failures</span>
</span></span><span class="line"><span class="cl"><span class="n">MAX_CONSECUTIVE_IMWRITE_FAILURES</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># Max consecutive cv2.imwrite() failures before shutdown</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ENABLE_TIMESTAMP</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl"><span class="n">TIMESTAMP_FORMAT</span> <span class="o">=</span> <span class="s2">&#34;%Y/%m/</span><span class="si">%d</span><span class="s2"> %H:%M:%S&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">IMAGE_STORAGE_MONITOR_PATH</span> <span class="o">=</span> <span class="n">IMAGE_SAVE_BASE_DIR</span>
</span></span><span class="line"><span class="cl"><span class="n">IMAGE_STORAGE_MAX_USAGE_PERCENT</span> <span class="o">=</span> <span class="mi">85</span>
</span></span><span class="line"><span class="cl"><span class="n">IMAGE_STORAGE_CLEANUP_BATCH_DAYS</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">DISK_CHECK_INTERVAL_SECONDS</span> <span class="o">=</span> <span class="mi">14400</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- Global Variables ---</span>
</span></span><span class="line"><span class="cl"><span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl"><span class="n">shutdown_event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">consecutive_imwrite_failures</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># MODIFICATION v2.0.1</span>
</span></span><span class="line"><span class="cl"><span class="n">consecutive_read_failures</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c1"># MODIFICATION v2.0.1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 默认的轮廓比较参数 (可以根据您的实际测试调整这些值)</span>
</span></span><span class="line"><span class="cl"><span class="n">DEFAULT_CONTOUR_PIXEL_THRESHOLD</span> <span class="o">=</span> <span class="mi">25</span>   <span class="c1"># 用于生成初始差异图的像素强度阈值</span>
</span></span><span class="line"><span class="cl"><span class="n">DEFAULT_CONTOUR_KERNEL_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>   <span class="c1"># 形态学膨胀操作的卷积核大小</span>
</span></span><span class="line"><span class="cl"><span class="n">DEFAULT_CONTOUR_DILATION_ITERATIONS</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># 膨胀操作的迭代次数</span>
</span></span><span class="line"><span class="cl"><span class="n">DEFAULT_CONTOUR_MIN_AREA_FILTER</span> <span class="o">=</span> <span class="mf">50.0</span> <span class="c1"># 过滤掉小于此面积的差异轮廓</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">last_significant_frame</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl"><span class="n">SIMILARITY_THRESHOLD_PERCENT_INT</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># 例如0.5%</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- Logging Setup ---</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (setup_logging_system function from v2.0.0 is unchanged)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">setup_logging_system</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">log_file_prefix</span><span class="p">,</span> <span class="n">level_str</span><span class="p">,</span> <span class="n">when</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">backup_count</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="n">logger</span>
</span></span><span class="line"><span class="cl">    <span class="n">numeric_level</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">level_str</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">log_dir</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;CRITICAL: Failed to create log directory </span><span class="si">{</span><span class="n">log_dir</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">SCRIPT_NAME</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">numeric_level</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">## current_date_str = datetime.now().strftime(&#34;_%Y_%m_%d&#34;) # 例如：_2023_10_27</span>
</span></span><span class="line"><span class="cl">    <span class="c1">## current_date_str_new = datetime.now().strftime(&#34;%Y-%m-%d&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">## actual_log_file_name = f&#34;{log_file_prefix}.log.{current_date_str_new}&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">log_file_basename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">log_file_prefix</span><span class="si">}</span><span class="s2">.log&#34;</span> <span class="c1"># 例如 &#34;image_capture.log&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">log_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">log_file_basename</span><span class="p">)</span> <span class="c1"># 使用这个路径</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">hasHandlers</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> [</span><span class="si">%(levelname)-7s</span><span class="s1">] [</span><span class="si">%(name)s</span><span class="s1">:</span><span class="si">%(funcName)s</span><span class="s1">:</span><span class="si">%(lineno)d</span><span class="s1">] </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">## log_filepath = os.path.join(log_dir, actual_log_file_name)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">fh</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">TimedRotatingFileHandler</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">log_filepath</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="n">when</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span> <span class="n">backupCount</span><span class="o">=</span><span class="n">backup_count</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">fh</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">numeric_level</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">fh</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;WARNING: Failed to initialize file logger at </span><span class="si">{</span><span class="n">log_filepath</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ch</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">ch</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">numeric_level</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">ch</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Logging initialized. Level: </span><span class="si">{</span><span class="n">level_str</span><span class="si">}</span><span class="s2">. File: </span><span class="si">{</span><span class="n">log_filepath</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">logger</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- PID File Management ---</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (create_pid_file, remove_pid_file functions from v2.0.0 are unchanged)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create_pid_file</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">PID_FILE_PATH</span><span class="p">:</span> <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">PID_FILE_PATH</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">PID_FILE_PATH</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;PID file created at </span><span class="si">{</span><span class="n">PID_FILE_PATH</span><span class="si">}</span><span class="s2"> with PID </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Unable to create PID file </span><span class="si">{</span><span class="n">PID_FILE_PATH</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">remove_pid_file</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">PID_FILE_PATH</span><span class="p">:</span> <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">PID_FILE_PATH</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">PID_FILE_PATH</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;PID file </span><span class="si">{</span><span class="n">PID_FILE_PATH</span><span class="si">}</span><span class="s2"> removed.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Unable to remove PID file </span><span class="si">{</span><span class="n">PID_FILE_PATH</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- Signal Handling ---</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">signal_term_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;接收到信号 </span><span class="si">{</span><span class="n">signal</span><span class="o">.</span><span class="n">Signals</span><span class="p">(</span><span class="n">signum</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">signum</span><span class="si">}</span><span class="s2">)，开始优雅停机...&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">logger</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">shutdown_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- Core Camera and Image Processing Functions ---</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (get_fourcc_str, set_camera_parameter, initialize_camera, add_timestamp_to_frame</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  from v2.0.0 are good, ensure logger is used, and set_camera_parameter uses shutdown_event.wait)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_fourcc_str</span><span class="p">(</span><span class="n">fourcc_int</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="c1"># Identical to v2.0.0</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">fourcc_int</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&#34;N/A (0)&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">chr</span><span class="p">((</span><span class="n">fourcc_int</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;转换FOURCC整数 </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">fourcc_int</span><span class="p">)</span><span class="si">}</span><span class="s2"> 到字符串失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Unknown (</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">fourcc_int</span><span class="p">)</span><span class="si">}</span><span class="s2">)&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">set_camera_parameter</span><span class="p">(</span><span class="n">cap</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">,</span> <span class="n">prop_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">param_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                         <span class="n">retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">PARAMETER_SET_RETRIES</span><span class="p">,</span> <span class="n">delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">PARAMETER_SET_DELAY_SECONDS</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> <span class="c1"># Identical to v2.0.0</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;尝试设置摄像头参数 </span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2"> 为 </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">retries</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">cap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">prop_id</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">shutdown_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">delay</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span> <span class="c1"># Shutdown requested</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">actual_value</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prop_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">is_set</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">requested_value_for_log</span> <span class="o">=</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">        <span class="n">actual_value_for_log</span> <span class="o">=</span> <span class="n">actual_value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">prop_id</span> <span class="o">==</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FOURCC</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">target_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">            <span class="n">actual_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">actual_value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">is_set</span> <span class="o">=</span> <span class="p">(</span><span class="n">actual_int</span> <span class="o">==</span> <span class="n">target_int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">requested_value_for_log</span> <span class="o">=</span> <span class="n">get_fourcc_str</span><span class="p">(</span><span class="n">target_int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">actual_value_for_log</span> <span class="o">=</span> <span class="n">get_fourcc_str</span><span class="p">(</span><span class="n">actual_int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">is_set</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">actual_value</span><span class="p">)</span> <span class="o">-</span> <span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-9</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">            <span class="n">is_set</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">actual_value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;尝试 </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2"> 设置 </span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">: 请求 </span><span class="si">{</span><span class="n">requested_value_for_log</span><span class="si">}</span><span class="s2">, 实际 </span><span class="si">{</span><span class="n">actual_value_for_log</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">is_set</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;参数 </span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2"> 成功设置为 </span><span class="si">{</span><span class="n">requested_value_for_log</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">    <span class="n">final_actual_value</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prop_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">prop_id</span> <span class="o">==</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FOURCC</span><span class="p">:</span> <span class="n">final_actual_value</span> <span class="o">=</span> <span class="n">get_fourcc_str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">final_actual_value</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;无法将参数 </span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2"> 设置为 </span><span class="si">{</span><span class="n">requested_value_for_log</span><span class="si">}</span><span class="s2"> &#34;</span>
</span></span><span class="line"><span class="cl">                   <span class="sa">f</span><span class="s2">&#34;经过 </span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2"> 次尝试后，实际值为 </span><span class="si">{</span><span class="n">final_actual_value</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">initialize_camera</span><span class="p">(</span><span class="n">camera_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">req_fourcc_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> <span class="c1"># Identical to v2.0.0</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;尝试打开并初始化设备 </span><span class="si">{</span><span class="n">camera_path</span><span class="si">}</span><span class="s2"> (使用 V4L2 后端)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">device_path</span> <span class="o">=</span> <span class="n">camera_path</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">device_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;摄像头设备节点 </span><span class="si">{</span><span class="n">device_path</span><span class="si">}</span><span class="s2"> 不存在。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&#34;NODE_NOT_FOUND&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">camera_path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CAP_V4L2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">cap</span><span class="o">.</span><span class="n">isOpened</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;无法打开摄像头 </span><span class="si">{</span><span class="n">camera_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&#34;OPEN_FAILED&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">effective_fourcc</span> <span class="o">=</span> <span class="s2">&#34;NOT_SET&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">req_fourcc_str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">target_fourcc_int</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter_fourcc</span><span class="p">(</span><span class="o">*</span><span class="n">req_fourcc_str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">set_camera_parameter</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FOURCC</span><span class="p">,</span> <span class="n">target_fourcc_int</span><span class="p">,</span> <span class="s2">&#34;FOURCC&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">set_camera_parameter</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&#34;FPS&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span> <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">();</span> <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&#34;SHUTDOWN_DURING_INIT&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">current_fourcc_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FOURCC</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">effective_fourcc</span> <span class="o">=</span> <span class="n">get_fourcc_str</span><span class="p">(</span><span class="n">current_fourcc_int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">req_fourcc_str</span> <span class="ow">and</span> <span class="n">effective_fourcc</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">req_fourcc_str</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">         <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;请求的FOURCC </span><span class="si">{</span><span class="n">req_fourcc_str</span><span class="si">}</span><span class="s2"> 未能精确设置，摄像头实际为 </span><span class="si">{</span><span class="n">effective_fourcc</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">set_camera_parameter</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="s2">&#34;Width&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span> <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">();</span> <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&#34;SHUTDOWN_DURING_INIT&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">set_camera_parameter</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="s2">&#34;Height&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span> <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">();</span> <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&#34;SHUTDOWN_DURING_INIT&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">actual_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">actual_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">actual_fps_val</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">current_fourcc_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FOURCC</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">    <span class="n">effective_fourcc</span> <span class="o">=</span> <span class="n">get_fourcc_str</span><span class="p">(</span><span class="n">current_fourcc_int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;摄像头 </span><span class="si">{</span><span class="n">camera_path</span><span class="si">}</span><span class="s2"> 初始化完成。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  请求参数 -&gt; FOURCC: </span><span class="si">{</span><span class="n">req_fourcc_str</span> <span class="k">if</span> <span class="n">req_fourcc_str</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span><span class="si">}</span><span class="s2">, 尺寸: </span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  实际参数 -&gt; FOURCC: </span><span class="si">{</span><span class="n">effective_fourcc</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">current_fourcc_int</span><span class="p">)</span><span class="si">}</span><span class="s2">), &#34;</span>
</span></span><span class="line"><span class="cl">                <span class="sa">f</span><span class="s2">&#34;尺寸: </span><span class="si">{</span><span class="n">actual_width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">actual_height</span><span class="si">}</span><span class="s2">, &#34;</span>
</span></span><span class="line"><span class="cl">                <span class="sa">f</span><span class="s2">&#34;报告FPS: </span><span class="si">{</span><span class="n">actual_fps_val</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">actual_width</span> <span class="o">!=</span> <span class="n">width</span> <span class="ow">or</span> <span class="n">actual_height</span> <span class="o">!=</span> <span class="n">height</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;摄像头实际分辨率 </span><span class="si">{</span><span class="n">actual_width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">actual_height</span><span class="si">}</span><span class="s2"> 与请求的 </span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s2"> 不符！&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">cap</span><span class="p">,</span> <span class="n">effective_fourcc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add_timestamp_to_frame</span><span class="p">(</span><span class="n">frame_to_modify</span><span class="p">,</span> <span class="n">timestamp_format_str</span><span class="p">):</span> <span class="c1"># Identical to v2.0.0</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">ENABLE_TIMESTAMP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">frame_to_modify</span>
</span></span><span class="line"><span class="cl">    <span class="n">timestamp_text</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">timestamp_format_str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">font</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span>
</span></span><span class="line"><span class="cl">    <span class="n">img_h</span><span class="p">,</span> <span class="n">img_w</span> <span class="o">=</span> <span class="n">frame_to_modify</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">font_scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_h</span> <span class="o">/</span> <span class="mf">1080.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">font_scale</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span> <span class="n">font_scale</span> <span class="o">=</span> <span class="mf">0.5</span>
</span></span><span class="line"><span class="cl">    <span class="n">thickness</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">font_scale</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">    <span class="n">margin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">img_h</span> <span class="o">*</span> <span class="mf">0.05</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">text_size</span><span class="p">,</span> <span class="n">baseline</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getTextSize</span><span class="p">(</span><span class="n">timestamp_text</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="n">font_scale</span><span class="p">,</span> <span class="n">thickness</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">text_width</span><span class="p">,</span> <span class="n">text_height</span> <span class="o">=</span> <span class="n">text_size</span>
</span></span><span class="line"><span class="cl">    <span class="n">org_x</span> <span class="o">=</span> <span class="n">img_w</span> <span class="o">-</span> <span class="n">text_width</span> <span class="o">-</span> <span class="n">margin</span>
</span></span><span class="line"><span class="cl">    <span class="n">org_y</span> <span class="o">=</span> <span class="n">img_h</span> <span class="o">-</span> <span class="n">margin</span> 
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame_to_modify</span><span class="p">,</span> <span class="n">timestamp_text</span><span class="p">,</span> <span class="p">(</span><span class="n">org_x</span><span class="p">,</span> <span class="n">org_y</span><span class="p">),</span> <span class="n">font</span><span class="p">,</span> <span class="n">font_scale</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="n">thickness</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">,</span> <span class="n">bottomLeftOrigin</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">frame_to_modify</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">are_frames_similar</span><span class="p">(</span><span class="n">frame1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="n">frame2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="n">similarity_diff_rate_threshold_int</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    比较两个帧的相似度，基于轮廓面积差异率。
</span></span></span><span class="line"><span class="cl"><span class="s2">    帧的顺序无关。
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    参数:
</span></span></span><span class="line"><span class="cl"><span class="s2">        frame1: 第一个帧 (NumPy array) 或 None。
</span></span></span><span class="line"><span class="cl"><span class="s2">        frame2: 第二个帧 (NumPy array) 或 None。
</span></span></span><span class="line"><span class="cl"><span class="s2">        similarity_diff_rate_threshold_int (int): 相似度百分比阈值。
</span></span></span><span class="line"><span class="cl"><span class="s2">            这是一个整数，例如 50 代表差异率上限为 0.50%。
</span></span></span><span class="line"><span class="cl"><span class="s2">            如果实际差异率 &lt;= 此阈值对应的百分比，则认为帧相似。
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    返回:
</span></span></span><span class="line"><span class="cl"><span class="s2">        bool:
</span></span></span><span class="line"><span class="cl"><span class="s2">            - 如果任一帧无法解析为有效图像 (例如 None 或类型不对)，返回 False (不相似/无法比较)。
</span></span></span><span class="line"><span class="cl"><span class="s2">            - 如果轮廓面积差异率 &lt;= (similarity_diff_rate_threshold_int / 100.0)%，返回 True (相似/变化小)。
</span></span></span><span class="line"><span class="cl"><span class="s2">            - 否则 (差异率较大)，返回 False (不相似/变化大)。
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 1. 检查输入帧的有效性</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># cap.read() 返回的 ret, frame。如果 ret 是 False，frame可能是 None 或无效数据</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frame1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">frame1</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;are_frames_similar: frame1 无效 (非 NumPy 数组、None 或空数组)。返回 False。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frame2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">frame2</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;are_frames_similar: frame2 无效 (非 NumPy 数组、None 或空数组)。返回 False。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 2. 确保图像尺寸相同 (将 frame2 调整为 frame1 的尺寸)</span>
</span></span><span class="line"><span class="cl">    <span class="n">h1</span><span class="p">,</span> <span class="n">w1</span> <span class="o">=</span> <span class="n">frame1</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">h2</span><span class="p">,</span> <span class="n">w2</span> <span class="o">=</span> <span class="n">frame2</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">frame2_resized</span> <span class="o">=</span> <span class="n">frame2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">h1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">h2</span><span class="p">,</span> <span class="n">w2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;are_frames_similar: 帧尺寸不同。将 frame2 从 (</span><span class="si">{</span><span class="n">w2</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">h2</span><span class="si">}</span><span class="s2">) 调整为 (</span><span class="si">{</span><span class="n">w1</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">h1</span><span class="si">}</span><span class="s2">)。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">frame2_resized</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">frame2</span><span class="p">,</span> <span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">h1</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_AREA</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="n">cv2</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;are_frames_similar: 调整 frame2 尺寸失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">。返回 False。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span> <span class="c1"># 调整尺寸失败，无法比较</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 3. 转换为灰度图进行比较</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#    确保处理单通道和三通道输入，最终得到单通道灰度图</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">frame1</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">frame1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># BGR</span>
</span></span><span class="line"><span class="cl">            <span class="n">gray1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">frame1</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># Already grayscale</span>
</span></span><span class="line"><span class="cl">            <span class="n">gray1</span> <span class="o">=</span> <span class="n">frame1</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;are_frames_similar: frame1 格式未知 (shape: </span><span class="si">{</span><span class="n">frame1</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">)。返回 False。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">frame2_resized</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">frame2_resized</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># BGR</span>
</span></span><span class="line"><span class="cl">            <span class="n">gray2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame2_resized</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">frame2_resized</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># Already grayscale</span>
</span></span><span class="line"><span class="cl">            <span class="n">gray2</span> <span class="o">=</span> <span class="n">frame2_resized</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;are_frames_similar: frame2_resized 格式未知 (shape: </span><span class="si">{</span><span class="n">frame2_resized</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">)。返回 False。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="n">cv2</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;are_frames_similar: 转换为灰度图失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">。返回 False。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 4. 计算轮廓面积差异率</span>
</span></span><span class="line"><span class="cl">    <span class="n">image_total_pixels</span> <span class="o">=</span> <span class="n">gray1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">gray1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">image_total_pixels</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;are_frames_similar: 图像总像素为0。返回 False。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">abs_diff_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">absdiff</span><span class="p">(</span><span class="n">gray1</span><span class="p">,</span> <span class="n">gray2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_</span><span class="p">,</span> <span class="n">thresh_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">abs_diff_img</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">DEFAULT_CONTOUR_PIXEL_THRESHOLD</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="mi">255</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">DEFAULT_CONTOUR_KERNEL_SIZE</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">dilated_thresh_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="n">thresh_img</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">kernel</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">iterations</span><span class="o">=</span><span class="n">DEFAULT_CONTOUR_DILATION_ITERATIONS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">contours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">dilated_thresh_img</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">total_significant_contour_area</span> <span class="o">=</span> <span class="mf">0.0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">current_contour_area</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">current_contour_area</span> <span class="o">&gt;</span> <span class="n">DEFAULT_CONTOUR_MIN_AREA_FILTER</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">total_significant_contour_area</span> <span class="o">+=</span> <span class="n">current_contour_area</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">contour_area_actual_diff_rate_percent</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_significant_contour_area</span> <span class="o">/</span> <span class="n">image_total_pixels</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 5. 根据阈值判断是否相似</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 将传入的整数阈值转换为实际百分比上限</span>
</span></span><span class="line"><span class="cl">    <span class="n">similarity_threshold_as_percentage</span> <span class="o">=</span> <span class="n">similarity_diff_rate_threshold_int</span> <span class="o">/</span> <span class="mf">100.0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;are_frames_similar: 实际轮廓差异率: </span><span class="si">{</span><span class="n">contour_area_actual_diff_rate_percent</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">%, &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                 <span class="sa">f</span><span class="s2">&#34;设定的相似度差异上限: </span><span class="si">{</span><span class="n">similarity_threshold_as_percentage</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">% &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                 <span class="sa">f</span><span class="s2">&#34;(传入整数: </span><span class="si">{</span><span class="n">similarity_diff_rate_threshold_int</span><span class="si">}</span><span class="s2">)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">contour_area_actual_diff_rate_percent</span> <span class="o">&lt;=</span> <span class="n">similarity_threshold_as_percentage</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 差异小或等于阈值，认为相似 (变化小)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># logger.info(f&#34;are_frames_similar: 差异率达标{contour_area_actual_diff_rate_percent:.4f}%，判定为相似 (True)。&#34;)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 差异大，认为不相似 (变化大)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># logger.info(f&#34;are_frames_similar: 差异率超标{contour_area_actual_diff_rate_percent:.4f}%，判定为不相似 (False)。&#34;)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">process_and_save_frame</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">effective_fourcc</span><span class="p">,</span> <span class="n">base_save_dir</span><span class="p">,</span> <span class="n">jpeg_quality_val</span><span class="p">,</span> <span class="n">ts_format</span><span class="p">):</span> <span class="c1"># Identical to v2.0.0</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="n">consecutive_imwrite_failures</span> <span class="c1"># MODIFICATION v2.0.1</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="n">last_significant_frame</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">frame_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;接收到空帧，无法处理。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;接收到帧。原始 - 尺寸: </span><span class="si">{</span><span class="n">frame_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, dtype: </span><span class="si">{</span><span class="n">frame_data</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">, FOURCC上下文: </span><span class="si">{</span><span class="n">effective_fourcc</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">processed_frame</span> <span class="o">=</span> <span class="n">frame_data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># try:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#    target_size = (1920, 1080)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#    if frame_data.shape[1] != target_size[0] or frame_data.shape[0] != target_size[1]:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#        processed_frame = cv2.resize(frame_data, target_size, interpolation=cv2.INTER_LANCZOS4)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#        logger.info(f&#34;图像缩放完成（高精度），目标尺寸: {target_size}&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#except Exception as e:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#    logger.error(f&#34;图像缩放失败: {e}&#34;, exc_info=True)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">effective_fourcc</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;YUYV&#39;</span><span class="p">,</span> <span class="s1">&#39;YUY2&#39;</span><span class="p">]</span> <span class="ow">and</span> \
</span></span><span class="line"><span class="cl">       <span class="ow">not</span> <span class="p">(</span><span class="n">processed_frame</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">processed_frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;帧的FOURCC上下文为 </span><span class="si">{</span><span class="n">effective_fourcc</span><span class="si">}</span><span class="s2"> 且非BGR，尝试YUV-&gt;BGR转换。帧Shape: </span><span class="si">{</span><span class="n">processed_frame</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">processed_frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">DEFAULT_WIDTH</span> <span class="o">*</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">processed_frame</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">                 <span class="n">processed_frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">processed_frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_YUV2BGR_YUYV</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="n">processed_frame</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">processed_frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">                 <span class="n">processed_frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">processed_frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_YUV2BGR_YUYV</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;未知的YUYV帧结构: </span><span class="si">{</span><span class="n">processed_frame</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">，无法自动转换。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">processed_frame</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">processed_frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                 <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;YUV 转换为 BGR 成功. 新图像尺寸: </span><span class="si">{</span><span class="n">processed_frame</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">                 <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;YUV 转换为 BGR 后尺寸/通道数不正确: </span><span class="si">{</span><span class="n">processed_frame</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">. 保留原始帧。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="n">processed_frame</span> <span class="o">=</span> <span class="n">frame_data</span> 
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="n">cv2</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;YUV 转换为 BGR 失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. 将使用原始帧。&#34;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">processed_frame</span> <span class="o">=</span> <span class="n">frame_data</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">processed_frame</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;图像是单通道灰度图 (shape: </span><span class="si">{</span><span class="n">processed_frame</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">)，转换为BGR。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">processed_frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">processed_frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_GRAY2BGR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="n">processed_frame</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">processed_frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;图像格式未知或非预期 (shape: </span><span class="si">{</span><span class="n">processed_frame</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">). 尝试直接处理。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 判断是否接近，如果和上一次成功保存类似则直接跳过</span>
</span></span><span class="line"><span class="cl">    <span class="n">frames_are_indeed_similar</span> <span class="o">=</span> <span class="n">are_frames_similar</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">last_significant_frame</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">processed_frame</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">SIMILARITY_THRESHOLD_PERCENT_INT</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">frames_are_indeed_similar</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#if logger: # logger.info(f&#34;当前帧与上一显著帧相似 (差异 &lt;= {SIMILARITY_THRESHOLD_PERCENT_INT/100.0:.2f}%)，不保存。&#34;)</span>
</span></span><span class="line"><span class="cl">        <span class="n">perform_save_this_frame</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;SIMILARITY&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># if logger: logger.info(f&#34;当前帧与上一显著帧不相似 (差异 &gt; {SIMILARITY_THRESHOLD_PERCENT_INT/100.0:.2f}%)，将保存。&#34;)</span>
</span></span><span class="line"><span class="cl">        <span class="n">perform_save_this_frame</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">last_significant_frame</span> <span class="o">=</span> <span class="n">processed_frame</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">frame_with_timestamp</span> <span class="o">=</span> <span class="n">add_timestamp_to_frame</span><span class="p">(</span><span class="n">processed_frame</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">ts_format</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;添加时间戳失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. 将保存不带时间戳的图像。&#34;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">frame_with_timestamp</span> <span class="o">=</span> <span class="n">processed_frame</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">save_subdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_save_dir</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&#34;%Y-%m&#34;</span><span class="p">),</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%d</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_subdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;创建目录 </span><span class="si">{</span><span class="n">save_subdir</span><span class="si">}</span><span class="s2"> 失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. 无法保存图像。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">consecutive_imwrite_failures</span> <span class="o">+=</span><span class="mi">1</span> <span class="c1"># MODIFICATION v2.0.1</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#time_str = now.strftime(&#34;%H%M%S_%f&#34;) </span>
</span></span><span class="line"><span class="cl">    <span class="c1">#filename = f&#34;{time_str}.jpg&#34; </span>
</span></span><span class="line"><span class="cl">    <span class="c1">#filepath = os.path.join(save_subdir, filename)</span>
</span></span><span class="line"><span class="cl">    <span class="n">file_timestamp</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&#34;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S_</span><span class="si">%f</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;capture_</span><span class="si">{</span><span class="n">file_timestamp</span><span class="si">}</span><span class="s2">.jpg&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_subdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="c1"># 保存到年月子目录中</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;尝试将图像保存到: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2"> (质量: </span><span class="si">{</span><span class="n">jpeg_quality_val</span><span class="si">}</span><span class="s2">)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">save_success</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">frame_with_timestamp</span><span class="p">,</span> <span class="p">[</span><span class="n">cv2</span><span class="o">.</span><span class="n">IMWRITE_JPEG_QUALITY</span><span class="p">,</span> <span class="n">jpeg_quality_val</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">save_success</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;图像成功保存为JPEG: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">consecutive_imwrite_failures</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># MODIFICATION v2.0.1: Reset on success</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="mo">0o644</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;文件权限设置为 644: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;设置文件 </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2"> 权限失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">filepath</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;cv2.imwrite 保存JPEG图像失败 (返回False): </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">consecutive_imwrite_failures</span> <span class="o">+=</span><span class="mi">1</span> <span class="c1"># MODIFICATION v2.0.1</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;cv2.imwrite 保存图像时发生异常: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">consecutive_imwrite_failures</span> <span class="o">+=</span><span class="mi">1</span> <span class="c1"># MODIFICATION v2.0.1</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- Disk Space Management ---</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_oldest_day_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Identical to v2.0.0</span>
</span></span><span class="line"><span class="cl">    <span class="n">all_day_paths</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;get_oldest_day_dir: Base directory &#39;</span><span class="si">{</span><span class="n">base_dir</span><span class="si">}</span><span class="s2">&#39; not found or not a directory.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">ym_dir_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ym_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">ym_dir_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">ym_path</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ym_dir_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span> <span class="ow">and</span> <span class="n">ym_dir_name</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span> <span class="c1"># Valid YYYY-MM</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">d_dir_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">ym_path</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                <span class="n">d_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ym_path</span><span class="p">,</span> <span class="n">d_dir_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">d_path</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">d_dir_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># Valid DD</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span><span class="p">:</span> <span class="c1"># Ensure DD is integer, further validating format</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">int</span><span class="p">(</span><span class="n">d_dir_name</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">                        <span class="n">all_day_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Skipping non-day directory: </span><span class="si">{</span><span class="n">d_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">all_day_paths</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">all_day_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Lexicographical sort of YYYY-MM/DD is chronological</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">check_and_manage_disk_space</span><span class="p">():</span> <span class="c1"># Identical to v2.0.0 logic</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">usage</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">disk_usage</span><span class="p">(</span><span class="n">IMAGE_STORAGE_MONITOR_PATH</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">percent_used</span> <span class="o">=</span> <span class="p">(</span><span class="n">usage</span><span class="o">.</span><span class="n">used</span> <span class="o">/</span> <span class="n">usage</span><span class="o">.</span><span class="n">total</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;磁盘空间监控: </span><span class="si">{</span><span class="n">IMAGE_STORAGE_MONITOR_PATH</span><span class="si">}</span><span class="s2"> - Total: </span><span class="si">{</span><span class="n">usage</span><span class="o">.</span><span class="n">total</span> <span class="o">//</span> <span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">GB, &#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="sa">f</span><span class="s2">&#34;Used: </span><span class="si">{</span><span class="n">usage</span><span class="o">.</span><span class="n">used</span> <span class="o">//</span> <span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">GB (</span><span class="si">{</span><span class="n">percent_used</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%), &#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="sa">f</span><span class="s2">&#34;Free: </span><span class="si">{</span><span class="n">usage</span><span class="o">.</span><span class="n">free</span> <span class="o">//</span> <span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">GB&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">percent_used</span> <span class="o">&gt;</span> <span class="n">IMAGE_STORAGE_MAX_USAGE_PERCENT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;磁盘使用率 (</span><span class="si">{</span><span class="n">percent_used</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%) 已超过阈值 (</span><span class="si">{</span><span class="n">IMAGE_STORAGE_MAX_USAGE_PERCENT</span><span class="si">}</span><span class="s2">%). &#34;</span>
</span></span><span class="line"><span class="cl">                           <span class="sa">f</span><span class="s2">&#34;尝试清理 </span><span class="si">{</span><span class="n">IMAGE_STORAGE_CLEANUP_BATCH_DAYS</span><span class="si">}</span><span class="s2"> 个最旧的日期目录...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">IMAGE_STORAGE_CLEANUP_BATCH_DAYS</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span> 
</span></span><span class="line"><span class="cl">                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;Shutdown requested during disk cleanup.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span> 
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="n">oldest_dir_to_delete</span> <span class="o">=</span> <span class="n">get_oldest_day_dir</span><span class="p">(</span><span class="n">IMAGE_SAVE_BASE_DIR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">oldest_dir_to_delete</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;准备删除最旧的日期目录 (</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">IMAGE_STORAGE_CLEANUP_BATCH_DAYS</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">oldest_dir_to_delete</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">oldest_dir_to_delete</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;已成功删除目录: </span><span class="si">{</span><span class="n">oldest_dir_to_delete</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;删除目录 </span><span class="si">{</span><span class="n">oldest_dir_to_delete</span><span class="si">}</span><span class="s2"> 失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span> 
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;没有找到可以删除的旧日期目录。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span> 
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;磁盘空间监控路径 </span><span class="si">{</span><span class="n">IMAGE_STORAGE_MONITOR_PATH</span><span class="si">}</span><span class="s2"> 未找到。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;检查或管理磁盘空间时发生错误: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- Get Current Capture Interval ---</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_current_capture_interval</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span> <span class="c1"># Identical to v2.0.0</span>
</span></span><span class="line"><span class="cl">    <span class="n">now_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">schedule_item</span> <span class="ow">in</span> <span class="n">CAPTURE_SCHEDULE_CONFIG</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">now_time</span> <span class="o">&lt;</span> <span class="n">schedule_item</span><span class="p">[</span><span class="s2">&#34;end_time_exclusive&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">schedule_item</span><span class="p">[</span><span class="s2">&#34;interval_seconds&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">DEFAULT_INTERVAL_LATE_NIGHT</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- Main Service Logic ---</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">run_capture_service</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="n">shutdown_event</span><span class="p">,</span> <span class="n">cap</span><span class="p">,</span> <span class="n">effective_fourcc</span> <span class="c1"># cap and effective_fourcc might be better as instance vars if this were a class</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="n">consecutive_imwrite_failures</span><span class="p">,</span> <span class="n">consecutive_read_failures</span> <span class="c1"># MODIFICATION v2.0.1</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="n">last_significant_frame</span>
</span></span><span class="line"><span class="cl">    <span class="n">last_significant_frame</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># 确保服务启动时重置</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cap</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Ensure cap is defined in this scope</span>
</span></span><span class="line"><span class="cl">    <span class="n">effective_fourcc</span> <span class="o">=</span> <span class="s2">&#34;NOT_SET_INITIALLY&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">init_failures</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">last_disk_check_time</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">consecutive_imwrite_failures</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Reset counters at service start</span>
</span></span><span class="line"><span class="cl">    <span class="n">consecutive_read_failures</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;图像捕获服务主逻辑启动。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ... (logging of schedule, camera target etc. from v2.0.0)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  时间表: &#34;</span> <span class="o">+</span> <span class="s2">&#34;, &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&#34;&lt;</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;end_time_exclusive&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;interval_seconds&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">s)&#34;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">CAPTURE_SCHEDULE_CONFIG</span><span class="p">])</span> <span class="o">+</span> 
</span></span><span class="line"><span class="cl">                <span class="sa">f</span><span class="s2">&#34;, &gt;=22:00 (</span><span class="si">{</span><span class="n">DEFAULT_INTERVAL_LATE_NIGHT</span><span class="si">}</span><span class="s2">s)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  目标摄像头: </span><span class="si">{</span><span class="n">DEFAULT_CAMERA_DEVICE_PATH</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  摄像头参数：</span><span class="si">{</span><span class="n">DEFAULT_WIDTH</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">DEFAULT_HEIGHT</span><span class="si">}</span><span class="s2">, FOURCC: </span><span class="si">{</span><span class="n">REQUESTED_FOURCC</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  图片保存至: </span><span class="si">{</span><span class="n">IMAGE_SAVE_BASE_DIR</span><span class="si">}</span><span class="s2"> (JPEG质量: </span><span class="si">{</span><span class="n">JPEG_SAVE_QUALITY</span><span class="si">}</span><span class="s2">)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  磁盘监控: 路径 &#39;</span><span class="si">{</span><span class="n">IMAGE_STORAGE_MONITOR_PATH</span><span class="si">}</span><span class="s2">&#39;, 阈值 </span><span class="si">{</span><span class="n">IMAGE_STORAGE_MAX_USAGE_PERCENT</span><span class="si">}</span><span class="s2">%&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">last_capture_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="ow">not</span> <span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">current_interval</span> <span class="o">=</span> <span class="n">get_current_capture_interval</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_monotonic_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">current_monotonic_time</span> <span class="o">-</span> <span class="n">last_disk_check_time</span> <span class="o">&gt;</span> <span class="n">DISK_CHECK_INTERVAL_SECONDS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">check_and_manage_disk_space</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="n">last_disk_check_time</span> <span class="o">=</span> <span class="n">current_monotonic_time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">cap</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cap</span><span class="o">.</span><span class="n">isOpened</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;摄像头未连接或需要重新初始化...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">cap</span><span class="p">:</span> <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="n">cap</span><span class="p">,</span> <span class="n">effective_fourcc</span> <span class="o">=</span> <span class="n">initialize_camera</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">DEFAULT_CAMERA_DEVICE_PATH</span><span class="p">,</span> <span class="n">DEFAULT_WIDTH</span><span class="p">,</span> <span class="n">DEFAULT_HEIGHT</span><span class="p">,</span> <span class="n">REQUESTED_FOURCC</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">cap</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">init_failures</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;摄像头初始化失败 (连续第 </span><span class="si">{</span><span class="n">init_failures</span><span class="si">}</span><span class="s2"> 次)。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">init_failures</span> <span class="o">&gt;=</span> <span class="n">CAMERA_INIT_FAILURE_MAX_CONSECUTIVE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;已连续 </span><span class="si">{</span><span class="n">init_failures</span><span class="si">}</span><span class="s2"> 次无法初始化摄像头。将等待较长时间 (</span><span class="si">{</span><span class="n">CAMERA_INIT_LONG_BACKOFF_SECONDS</span><span class="si">}</span><span class="s2">s) 后重试。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">shutdown_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">CAMERA_INIT_LONG_BACKOFF_SECONDS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">init_failures</span> <span class="o">=</span> <span class="mi">0</span> 
</span></span><span class="line"><span class="cl">                    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">shutdown_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">CAMERA_INIT_RETRY_DELAY_SECONDS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span> 
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="n">init_failures</span> <span class="o">=</span> <span class="mi">0</span> 
</span></span><span class="line"><span class="cl">                <span class="n">last_capture_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">                <span class="n">consecutive_read_failures</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Reset read failure counter on successful init</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">elapsed_since_last_capture</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_capture_time</span>
</span></span><span class="line"><span class="cl">            <span class="n">wait_time</span> <span class="o">=</span> <span class="n">current_interval</span> <span class="o">-</span> <span class="n">elapsed_since_last_capture</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">wait_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># logger.info(f&#34;当前时间: {datetime.now().strftime(&#39;%H:%M:%S&#39;)}, 间隔: {current_interval}s. 还需 {wait_time:.2f} 秒...&#34;)</span>
</span></span><span class="line"><span class="cl">                <span class="n">shutdown_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">wait_time</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span> <span class="k">break</span> 
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span> <span class="k">break</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">last_capture_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;尝试捕获图像帧 (当前间隔: </span><span class="si">{</span><span class="n">current_interval</span><span class="si">}</span><span class="s2">s)...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 清空缓冲帧</span>
</span></span><span class="line"><span class="cl">                <span class="n">cap</span><span class="o">.</span><span class="n">grab</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span> <span class="ow">or</span> <span class="n">frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;无法从摄像头获取图像帧。摄像头可能已断开连接或出现问题。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">consecutive_read_failures</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># MODIFICATION v2.0.1</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;连续读帧失败次数: </span><span class="si">{</span><span class="n">consecutive_read_failures</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">cap</span><span class="p">:</span> <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="n">cap</span> <span class="o">=</span> <span class="kc">None</span> 
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">consecutive_read_failures</span> <span class="o">&gt;=</span> <span class="n">MAX_CONSECUTIVE_READ_FAILURES</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;已连续 </span><span class="si">{</span><span class="n">consecutive_read_failures</span><span class="si">}</span><span class="s2"> 次无法读取帧。将等待较长时间 (</span><span class="si">{</span><span class="n">READ_FAILURE_LONG_BACKOFF_SECONDS</span><span class="si">}</span><span class="s2">s) 后尝试重连。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">shutdown_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">READ_FAILURE_LONG_BACKOFF_SECONDS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">consecutive_read_failures</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Reset after long backoff</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">shutdown_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">FRAME_READ_ERROR_RETRY_DELAY_SECONDS</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">consecutive_read_failures</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Reset on successful read MODIFICATION v2.0.1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">saved_filepath</span> <span class="o">=</span> <span class="n">process_and_save_frame</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">frame</span><span class="p">,</span> <span class="n">effective_fourcc</span><span class="p">,</span> <span class="n">IMAGE_SAVE_BASE_DIR</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                <span class="n">JPEG_SAVE_QUALITY</span><span class="p">,</span> <span class="n">TIMESTAMP_FORMAT</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">saved_filepath</span> <span class="o">==</span> <span class="s2">&#34;SIMILARITY&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;图像接近，跳过保存&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">saved_filepath</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">saved_filepath</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.jpg&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;图像捕获并成功保存: </span><span class="si">{</span><span class="n">saved_filepath</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># consecutive_imwrite_failures is reset inside process_and_save_frame</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;本次图像捕获未能成功保存。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># consecutive_imwrite_failures is incremented inside process_and_save_frame</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">consecutive_imwrite_failures</span> <span class="o">&gt;=</span> <span class="n">MAX_CONSECUTIVE_IMWRITE_FAILURES</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;已连续 </span><span class="si">{</span><span class="n">consecutive_imwrite_failures</span><span class="si">}</span><span class="s2"> 次无法保存图像到磁盘。服务将停止。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">shutdown_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span> <span class="c1"># Signal shutdown</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span> <span class="c1"># Exit while loop</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="n">cv2</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;主循环中发生 OpenCV 特定错误: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">cap</span><span class="p">:</span> <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">cap</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;因 OpenCV 错误，将等待 </span><span class="si">{</span><span class="n">CAMERA_INIT_RETRY_DELAY_SECONDS</span><span class="si">}</span><span class="s2">s 后尝试重启摄像头。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">shutdown_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">CAMERA_INIT_RETRY_DELAY_SECONDS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;主循环中发生未预料的严重错误: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">cap</span><span class="p">:</span> <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">            <span class="n">cap</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;因严重错误，将等待 </span><span class="si">{</span><span class="n">CAMERA_INIT_LONG_BACKOFF_SECONDS</span><span class="si">}</span><span class="s2">s 后尝试重启摄像头。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">shutdown_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">CAMERA_INIT_LONG_BACKOFF_SECONDS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Consider uncommenting &#39;raise&#39; for systemd to handle restart on truly unrecoverable errors</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># raise</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Loop exited (likely due to shutdown_event)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">cap</span> <span class="ow">and</span> <span class="n">cap</span><span class="o">.</span><span class="n">isOpened</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;正在释放摄像头资源...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;图像捕获服务主逻辑已停止。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- Main Application Entry Point &amp; CLI Argument Parsing ---</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="n">logger</span><span class="p">,</span> <span class="n">PID_FILE_PATH</span> <span class="c1"># Allow modification if args change them</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">SCRIPT_NAME</span><span class="si">}</span><span class="s2"> - Image Capture Service (v</span><span class="si">{</span><span class="n">SCRIPT_VERSION</span><span class="si">}</span><span class="s2">)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;foreground&#39;</span><span class="p">],</span> 
</span></span><span class="line"><span class="cl">                        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;foreground&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                        <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Action: start (daemonize - for traditional init), stop, status, or foreground (default, for systemd/debug).&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--pidfile&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">PID_FILE_PATH</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                        <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;Path to PID file (default: </span><span class="si">{</span><span class="n">PID_FILE_PATH</span><span class="si">}</span><span class="s2">)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--logdir&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">LOG_DIR</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;Path to log directory (default: </span><span class="si">{</span><span class="n">LOG_DIR</span><span class="si">}</span><span class="s2">)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--loglevel&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">LOG_LEVEL_CONFIG</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="s1">&#39;INFO&#39;</span><span class="p">,</span> <span class="s1">&#39;WARNING&#39;</span><span class="p">,</span> <span class="s1">&#39;ERROR&#39;</span><span class="p">,</span> <span class="s1">&#39;CRITICAL&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                        <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;Logging level (default: </span><span class="si">{</span><span class="n">LOG_LEVEL_CONFIG</span><span class="si">}</span><span class="s2">)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># For true daemonization with python-daemon, more args like --user, --group, --working-directory would be needed.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># For now, &#39;start&#39; is conceptual if not using systemd or a proper daemon library.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">PID_FILE_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pidfile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize logging system (now that PID_FILE_PATH for potential log inside pid dir is known)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">logdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Also ensure image save base dir exists before service starts trying to write into it.</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">IMAGE_SAVE_BASE_DIR</span><span class="p">):</span> <span class="c1"># This check should ideally use an absolute path too</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">IMAGE_SAVE_BASE_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># If using print before logger is initialized</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;CRITICAL: Failed to create essential directories (Log dir: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">logdir</span><span class="si">}</span><span class="s2"> or Image Base: </span><span class="si">{</span><span class="n">IMAGE_SAVE_BASE_DIR</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logging_system</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">logdir</span><span class="p">,</span> <span class="n">LOG_FILE_NAME</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">loglevel</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> 
</span></span><span class="line"><span class="cl">                                  <span class="n">LOG_ROTATE_WHEN</span><span class="p">,</span> <span class="n">LOG_ROTATE_INTERVAL</span><span class="p">,</span> <span class="n">LOG_ROTATE_BACKUP_COUNT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Handle actions</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;start&#39;</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;foreground&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="c1"># For &#39;start&#39;, implies daemonization is desired if not under systemd</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;Action &#39;start&#39;: Daemonization not yet fully implemented in this script for non-systemd. Running in foreground.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;For systemd, use Type=simple and run script directly (which defaults to foreground).&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># If using python-daemon, daemonization context would be entered here.</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># For now, &#39;start&#39; and &#39;foreground&#39; behave similarly.</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Starting </span><span class="si">{</span><span class="n">SCRIPT_NAME</span><span class="si">}</span><span class="s2"> v</span><span class="si">{</span><span class="n">SCRIPT_VERSION</span><span class="si">}</span><span class="s2"> in foreground mode...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Check PID file before creating a new one</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">PID_FILE_PATH</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">PID_FILE_PATH</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_pid_check</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">existing_pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f_pid_check</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">existing_pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># Check if process with this PID is running</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Service already running with PID </span><span class="si">{</span><span class="n">existing_pid</span><span class="si">}</span><span class="s2"> (found in </span><span class="si">{</span><span class="n">PID_FILE_PATH</span><span class="si">}</span><span class="s2">). If this is wrong, remove PID file and restart.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">ProcessLookupError</span><span class="p">):</span> 
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Found stale PID file </span><span class="si">{</span><span class="n">PID_FILE_PATH</span><span class="si">}</span><span class="s2">. Removing it.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">PID_FILE_PATH</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e_rm</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error removing stale PID file </span><span class="si">{</span><span class="n">PID_FILE_PATH</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e_rm</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">create_pid_file</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">signal_term_handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal_term_handler</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">run_capture_service</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Unhandled exception in run_capture_service: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span> <span class="c1"># Ensure full traceback is logged</span>
</span></span><span class="line"><span class="cl">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="k">finally</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">remove_pid_file</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">SCRIPT_NAME</span><span class="si">}</span><span class="s2"> has shut down.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;stop&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;Action: stop&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">PID_FILE_PATH</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;PID file </span><span class="si">{</span><span class="n">PID_FILE_PATH</span><span class="si">}</span><span class="s2"> not found. Service may not be running.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Changed to 1 as &#34;not running&#34; is often a failure for &#34;stop&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">PID_FILE_PATH</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Invalid PID file </span><span class="si">{</span><span class="n">PID_FILE_PATH</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Remove it manually if service is stuck.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Sending SIGTERM to process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">terminated_successfully</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Waiting up to 10 seconds for process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> to terminate...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span> <span class="c1"># Wait up to 10 seconds</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 等待1秒</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># 检查进程是否仍然存在</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> is still alive (attempt </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/10).&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">ProcessLookupError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> terminated successfully within </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> second(s).&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">terminated_successfully</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span> <span class="c1"># 进程已终止，退出等待循环</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e_check</span><span class="p">:</span> <span class="c1"># 其他检查时发生的错误</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error checking status for PID </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e_check</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># 发生错误，可能无法确认状态，也退出循环</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">terminated_successfully</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 如果10秒后循环正常结束，但进程未被确认终止（通常意味着os.kill(pid,0)没报错）</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> did not terminate after 10 seconds. Consider manual check or SIGKILL.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 您原始代码中在这之后还有一个try/except ProcessLookupError来做最后确认，</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 如果这里的逻辑是，即使循环完了，还想再确认一次，是可以保留的。</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 但如果上面的循环因为ProcessLookupError退出了，terminated_successfully会是true。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">ProcessLookupError</span><span class="p">:</span> <span class="c1"># 这个捕获的是 os.kill(pid, signal.SIGTERM) 时，进程就已经不存在的情况</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> was already terminated or PID was invalid when SIGTERM was attempted.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;No permission to send signal to process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">. Are you root?&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error stopping service: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">finally</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">terminated_successfully</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">PID_FILE_PATH</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 服务进程已被此 &#39;stop&#39; 命令确认终止，</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 但其 PID 文件仍然存在（服务可能未能自行删除）。</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 可以安全地将其作为陈旧 PID 文件移除。</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> terminated, but its PID file </span><span class="si">{</span><span class="n">PID_FILE_PATH</span><span class="si">}</span><span class="s2"> still exists. Removing stale PID file.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">remove_pid_file</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="ow">not</span> <span class="n">terminated_successfully</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">PID_FILE_PATH</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 服务进程未被此 &#39;stop&#39; 命令确认终止，且 PID 文件仍然存在。</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 此时不应自动删除 PID 文件，因为它可能仍然代表一个正在运行（但可能卡住）的进程。</span>
</span></span><span class="line"><span class="cl">                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> may still be running after stop attempt. PID file </span><span class="si">{</span><span class="n">PID_FILE_PATH</span><span class="si">}</span><span class="s2"> will not be removed by this &#39;stop&#39; action.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 如果 os.path.exists(PID_FILE_PATH) 为 False，说明PID文件已经被服务进程自己清掉了，或者一开始就没有，这里不需要额外操作。</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;Action: status&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">PID_FILE_PATH</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">SCRIPT_NAME</span><span class="si">}</span><span class="s2"> is not running (no PID file).&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">SCRIPT_NAME</span><span class="si">}</span><span class="s2"> is not running (no PID file).&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">PID_FILE_PATH</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">SCRIPT_NAME</span><span class="si">}</span><span class="s2"> status unknown (invalid PID file: </span><span class="si">{</span><span class="n">PID_FILE_PATH</span><span class="si">}</span><span class="s2">).&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Invalid PID file: </span><span class="si">{</span><span class="n">PID_FILE_PATH</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">SCRIPT_NAME</span><span class="si">}</span><span class="s2"> is running with PID </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">SCRIPT_NAME</span><span class="si">}</span><span class="s2"> is running with PID </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">ProcessLookupError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">SCRIPT_NAME</span><span class="si">}</span><span class="s2"> is not running (PID </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> from stale PID file </span><span class="si">{</span><span class="n">PID_FILE_PATH</span><span class="si">}</span><span class="s2"> not found).&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Stale PID file: process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> not found. Removing PID file.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">remove_pid_file</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">SCRIPT_NAME</span><span class="si">}</span><span class="s2"> with PID </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> seems to be running, but no permission to check fully.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Running with PID </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">, but no permission to check fully.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error checking status for PID </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error checking status for PID </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Basic signal handling for the main entry point itself, before run_capture_service sets its own</span>
</span></span><span class="line"><span class="cl">    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">signal_term_handler</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal_term_handler</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">SystemExit</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># sys.exit() was called, possibly by argparse or our own logic.</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># The exit code is in e.code. Logging already done or not needed.</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Simply re-raise to ensure the script exits with the correct code.</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Script explicitly exited with status </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2">.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Script explicitly exited with status </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2">.&#34;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Catch any other unexpected top-level exceptions</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span> <span class="c1"># If logger was initialized</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Unhandled top-level exception caused script termination: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span> <span class="c1"># Logger not even initialized, print to stderr</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;CRITICAL: Unhandled top-level exception: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># General error</span>
</span></span><span class="line"><span class="cl">    <span class="k">finally</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">logger</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span> <span class="c1"># If not already shutting down via signal</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;Script __main__ scope is finishing.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Ensure logging handlers are flushed and closed if script exits this way</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># However, if run_capture_service exited cleanly, it would call logging.shutdown()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># This is a final failsafe.</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">SCRIPT_NAME</span><span class="p">)</span><span class="o">.</span><span class="n">hasHandlers</span><span class="p">():</span> <span class="c1"># Check if logger was indeed set up</span>
</span></span><span class="line"><span class="cl">            <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>配套 systemctl 控制：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[Unit]</span>
</span></span><span class="line"><span class="cl"><span class="na">Description</span><span class="o">=</span><span class="s">Armbian Camera Capture Service</span>
</span></span><span class="line"><span class="cl"><span class="na">Documentation</span><span class="o">=</span><span class="s">https://your-documentation-url-here.com # 可选：指向您的文档</span>
</span></span><span class="line"><span class="cl"><span class="na">RequiresMountsFor</span><span class="o">=</span><span class="s">/opt/camera/captures</span>
</span></span><span class="line"><span class="cl"><span class="na">After</span><span class="o">=</span><span class="s">multi-user.target network.target opt-camera-captures.mount</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 如果明确知道摄像头设备，可以更精确地控制启动顺序</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 例如: Wants=dev-video2.device After=dev-video2.device</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[Service]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ---- 基本配置 ----</span>
</span></span><span class="line"><span class="cl"><span class="na">Type</span><span class="o">=</span><span class="s">simple</span>
</span></span><span class="line"><span class="cl"><span class="na">WorkingDirectory</span><span class="o">=</span><span class="s">/opt/camera</span>
</span></span><span class="line"><span class="cl"><span class="na">ExecStart</span><span class="o">=</span><span class="s">/opt/camera/opencv/bin/python /opt/camera/capture.py</span>
</span></span><span class="line"><span class="cl"><span class="na">ExecStop</span><span class="o">=</span><span class="s">/bin/kill -TERM $MAINPID</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ---- 自动重启策略 ----</span>
</span></span><span class="line"><span class="cl"><span class="na">Restart</span><span class="o">=</span><span class="s">on-failure # 或 &#39;always&#39;。&#39;on-failure&#39; 表示仅在脚本以非0状态退出时重启</span>
</span></span><span class="line"><span class="cl"><span class="na">RestartSec</span><span class="o">=</span><span class="s">10      # 重启前等待10秒</span>
</span></span><span class="line"><span class="cl"><span class="na">StartLimitIntervalSec</span><span class="o">=</span><span class="s">300 # 在300秒内</span>
</span></span><span class="line"><span class="cl"><span class="na">StartLimitBurst</span><span class="o">=</span><span class="s">5         # 最多尝试重启5次，防止无限重启循环</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ---- 日志和环境 ----</span>
</span></span><span class="line"><span class="cl"><span class="na">Environment</span><span class="o">=</span><span class="s">&#34;PYTHONUNBUFFERED=1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">StandardOutput</span><span class="o">=</span><span class="s">journal # 将Python脚本的stdout重定向到systemd journal</span>
</span></span><span class="line"><span class="cl"><span class="na">StandardError</span><span class="o">=</span><span class="s">journal  # 将Python脚本的stderr重定向到systemd journal</span>
</span></span><span class="line"><span class="cl"><span class="na">SyslogIdentifier</span><span class="o">=</span><span class="s">armbian-camera-capture</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ---- 安全性增强 (重要) ----</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 限制文件系统访问</span>
</span></span><span class="line"><span class="cl"><span class="na">ProtectSystem</span><span class="o">=</span><span class="s">strict     # /usr, /boot, /etc 设为只读</span>
</span></span><span class="line"><span class="cl"><span class="na">ProtectHome</span><span class="o">=</span><span class="s">true         # /home, /root 目录不可访问</span>
</span></span><span class="line"><span class="cl"><span class="na">PrivateTmp</span><span class="o">=</span><span class="s">true          # 使用私有的 /tmp 和 /var/tmp 目录</span>
</span></span><span class="line"><span class="cl"><span class="na">PrivateDevices</span><span class="o">=</span><span class="s">true      # 默认不暴露设备，除非通过 DeviceAllow 明确允许</span>
</span></span><span class="line"><span class="cl"><span class="na">ProtectKernelTunables</span><span class="o">=</span><span class="s">true</span>
</span></span><span class="line"><span class="cl"><span class="na">ProtectKernelModules</span><span class="o">=</span><span class="s">true</span>
</span></span><span class="line"><span class="cl"><span class="na">ProtectControlGroups</span><span class="o">=</span><span class="s">true</span>
</span></span><span class="line"><span class="cl"><span class="na">RestrictAddressFamilies</span><span class="o">=</span><span class="s">AF_UNIX # 根据需要调整，如果只用本地设备，AF_UNIX可能就够了</span>
</span></span><span class="line"><span class="cl"><span class="na">RestrictRealtime</span><span class="o">=</span><span class="s">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 限制权限提升</span>
</span></span><span class="line"><span class="cl"><span class="na">NoNewPrivileges</span><span class="o">=</span><span class="s">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 明确允许访问摄像头设备 (假设是 /dev/video2)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># DeviceAllow=/dev/video[1-6] rw</span>
</span></span><span class="line"><span class="cl"><span class="na">DeviceAllow</span><span class="o">=</span><span class="s">/dev/v4l/by-id/usb-Sonix_Technology_Co.__Ltd._UGREEN_Camera_2K_SN0001-video-index0 rw</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 如果还需要访问其他设备 (例如特定USB控制器)，也在此处添加</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 进一步限制能力 (根据脚本实际需要的能力，尽可能减少)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 对于这个脚本，除了设备访问，可能不需要太多其他特殊能力</span>
</span></span><span class="line"><span class="cl"><span class="na">CapabilityBoundingSet</span><span class="o">=</span><span class="s">~CAP_SYS_ADMIN CAP_NET_ADMIN CAP_SYS_PTRACE CAP_SYS_BOOT CAP_SYS_MODULE CAP_SYS_RAWIO CAP_SYS_TIME CAP_SETUID CAP_SETGID CAP_SETPCAP CAP_LINUX_IMMUTABLE CAP_IPC_LOCK CAP_IPC_OWNER CAP_SYSLOG CAP_MAC_ADMIN CAP_MAC_OVERRIDE CAP_NET_BROADCAST CAP_NET_BIND_SERVICE CAP_AUDIT_CONTROL CAP_AUDIT_READ CAP_AUDIT_WRITE</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 上面是排除了很多不必要的能力，保留了默认需要的一些基本能力。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 如果脚本非常简单，可以进一步收紧。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ---- 资源限制 (可选) ----</span>
</span></span><span class="line"><span class="cl"><span class="c1"># LimitNOFILE=1024        # 最大打开文件数</span>
</span></span><span class="line"><span class="cl"><span class="c1"># LimitNPROC=512          # 最大进程数</span>
</span></span><span class="line"><span class="cl"><span class="c1"># CPUQuota=50%            # CPU使用配额</span>
</span></span><span class="line"><span class="cl"><span class="c1"># MemoryMax=512M          # 最大内存使用</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ---- 超时设置 ----</span>
</span></span><span class="line"><span class="cl"><span class="na">TimeoutStopSec</span><span class="o">=</span><span class="s">30s        # 优雅停止的超时时间 (默认90s)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[Install]</span>
</span></span><span class="line"><span class="cl"><span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2023 - 
        
        2025 牙刷刷
    </section>
    
    <section class="powerby">
        
            牙刷刷的小站 版权所有 © 2025 <br/>
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
